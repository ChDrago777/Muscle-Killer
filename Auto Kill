-- Часть 1: Key System
local expectedKey = "Tea"
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

if not LocalPlayer:FindFirstChild("KeyValidated") then
    local KeyUI = Instance.new("ScreenGui", PlayerGui)
    KeyUI.Name = "KeyUI"

    local Frame = Instance.new("Frame", KeyUI)
    Frame.Size = UDim2.new(0, 250, 0, 120)
    Frame.Position = UDim2.new(0.5, -125, 0.5, -60)
    Frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    Frame.Active = true
    Frame.Draggable = true
    Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 8)

    local Box = Instance.new("TextBox", Frame)
    Box.Size = UDim2.new(1, -20, 0, 40)
    Box.Position = UDim2.new(0, 10, 0, 20)
    Box.Text = ""
    Box.PlaceholderText = ""
    Box.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    Box.TextColor3 = Color3.new(1, 1, 1)
    Box.ClearTextOnFocus = false
    Box.Font = Enum.Font.Gotham
    Box.TextSize = 16
    Instance.new("UICorner", Box).CornerRadius = UDim.new(0, 6)

    local Btn = Instance.new("TextButton", Frame)
    Btn.Size = UDim2.new(1, -20, 0, 30)
    Btn.Position = UDim2.new(0, 10, 0, 70)
    Btn.Text = "Submit"
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 16
    Btn.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    Btn.TextColor3 = Color3.new(1, 1, 1)
    Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)

    local validated = false
    Btn.MouseButton1Click:Connect(function()
        if Box.Text == expectedKey then
            validated = true
            KeyUI:Destroy()
            local val = Instance.new("BoolValue", LocalPlayer)
            val.Name = "KeyValidated"
        else
            Box.Text = ""
            Box.PlaceholderText = "Invalid Key!"
        end
    end)

    repeat task.wait() until validated
end
-- Часть 2: Инициализация и цвета
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")
local CoreGui = game:GetService("CoreGui")

local muscleEvent = ReplicatedStorage:FindFirstChild("muscleEvent") or LocalPlayer:FindFirstChild("muscleEvent")
if not muscleEvent then warn("❌ muscleEvent не найден") return end

local COLORS = {
    Background = Color3.fromRGB(25, 25, 25),
    Button = Color3.fromRGB(50, 50, 50),
    ButtonActive = Color3.fromRGB(255, 50, 50),
    Text = Color3.new(1, 1, 1),
    TextBox = Color3.fromRGB(35, 35, 35)
}

local function Create(class, props)
    local inst = Instance.new(class)
    for k, v in pairs(props) do inst[k] = v end
    return inst
end
-- Часть 3: Главное окно UI
local MainGui = Create("ScreenGui", {Name = "MuscleKillerUI", Parent = PlayerGui, ResetOnSpawn = false})
local Frame = Create("Frame", {
    Parent = MainGui,
    Size = UDim2.new(0, 350, 0, 360),
    Position = UDim2.new(0.5, -175, 0.5, -180),
    BackgroundColor3 = COLORS.Background,
    BackgroundTransparency = 0.3,
    BorderSizePixel = 0,
    Active = true,
    Draggable = true,
})
Create("UICorner", {Parent = Frame, CornerRadius = UDim.new(0, 12)})
Create("TextLabel", {
    Parent = Frame,
    Size = UDim2.new(1, 0, 0, 36),
    Text = "AutoㅤKillㅤMuscle",
    Font = Enum.Font.GothamBold,
    TextSize = 18,
    TextColor3 = COLORS.Text,
    BackgroundTransparency = 1,
})

local Content = Create("Frame", {
    Parent = Frame,
    Position = UDim2.new(0, 10, 0, 42),
    Size = UDim2.new(1, -20, 1, -52),
    BackgroundTransparency = 1,
})
local layout = Create("UIListLayout", {Parent = Content, Padding = UDim.new(0, 6), FillDirection = Enum.FillDirection.Vertical})
layout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    Frame.Size = UDim2.new(0, 350, 0, layout.AbsoluteContentSize.Y + 52)
    Content.Size = UDim2.new(1, -20, 0, layout.AbsoluteContentSize.Y)
end)
-- Часть 4: Whitelist
local WHITELIST = {}

local function IsWhitelisted(p)
    for _, name in ipairs(WHITELIST) do
        if p.Name:lower() == name:lower() or p.DisplayName:lower() == name:lower() then
            return true
        end
    end
    return false
end

local function AddFriendToWhitelist(p)
    if not table.find(WHITELIST, p.Name) then
        table.insert(WHITELIST, p.Name)
    end
end

local autoWhitelist = false
Players.PlayerAdded:Connect(function(p)
    if autoWhitelist then
        pcall(function()
            if LocalPlayer:IsFriendsWith(p.UserId) then
                AddFriendToWhitelist(p)
            end
        end)
    end
end)
-- Часть 5: Система наблюдения (Spectate)
local spectateBox = Create("TextBox", {
    Parent = Content,
    PlaceholderText = "Spectate (Name/Display)",
    Text = "",
    Size = UDim2.new(1, 0, 0, 30),
    BackgroundColor3 = COLORS.TextBox,
    TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham,
    TextSize = 14,
    ClearTextOnFocus = false,
})
Create("UICorner", {Parent = spectateBox, CornerRadius = UDim.new(0, 8)})

local spectatingConnection = nil
spectateBox.FocusLost:Connect(function()
    local v = spectateBox.Text
    local target = Players:FindFirstChild(v)
    if not target then
        for _, p in pairs(Players:GetPlayers()) do
            if p.DisplayName:lower() == v:lower() then target = p break end
        end
    end
    if target and target.Character then
        workspace.CurrentCamera.CameraSubject = target.Character:WaitForChild("Humanoid")
        if spectatingConnection then spectatingConnection:Disconnect() end
        spectatingConnection = target.CharacterAdded:Connect(function(c)
            workspace.CurrentCamera.CameraSubject = c:WaitForChild("Humanoid")
        end)
    end
end)

local stopSpectateBtn = Create("TextButton", {
    Parent = Content, Size = UDim2.new(1, 0, 0, 30),
    Text = "StopㅤSpectate",
    BackgroundColor3 = COLORS.Button, TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham, TextSize = 14,
})
Create("UICorner", {Parent = stopSpectateBtn, CornerRadius = UDim.new(0, 8)})
stopSpectateBtn.MouseButton1Click:Connect(function()
    if spectatingConnection then spectatingConnection:Disconnect() end
    workspace.CurrentCamera.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") or workspace.CurrentCamera.CameraSubject
end)
-- Часть 6: Выбор цели и радиус атаки
local nameBox = Create("TextBox", {
    Parent = Content,
    PlaceholderText = "Kill Target (Name/Display)",
    Text = "",
    Size = UDim2.new(1, 0, 0, 30),
    BackgroundColor3 = COLORS.TextBox,
    TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham,
    TextSize = 14,
    ClearTextOnFocus = false,
})
Create("UICorner", {Parent = nameBox, CornerRadius = UDim.new(0, 8)})

local radiusBox = Create("TextBox", {
    Parent = Content,
    PlaceholderText = "Kill Aura Radius (75-1000)",
    Text = "75",
    Size = UDim2.new(1, 0, 0, 30),
    BackgroundColor3 = COLORS.TextBox,
    TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham,
    TextSize = 14,
    ClearTextOnFocus = false,
})
Create("UICorner", {Parent = radiusBox, CornerRadius = UDim.new(0, 8)})
-- Часть 7: Управление белым списком
local whitelistBox = Create("TextBox", {
    Parent = Content,
    PlaceholderText = "Add to Whitelist (Name/Display)",
    Text = "",
    Size = UDim2.new(1, 0, 0, 30),
    BackgroundColor3 = COLORS.TextBox,
    TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham,
    TextSize = 14,
    ClearTextOnFocus = false,
})
Create("UICorner", {Parent = whitelistBox, CornerRadius = UDim.new(0, 8)})

whitelistBox.FocusLost:Connect(function()
    local input = whitelistBox.Text
    if input ~= "" then
        table.insert(WHITELIST, input)
        whitelistBox.Text = ""
    end
end)

local autoFriendBtn = Create("TextButton", {
    Parent = Content,
    Size = UDim2.new(1, 0, 0, 30),
    Text = "AutoㅤWhitelistㅤFriends",
    BackgroundColor3 = COLORS.Button,
    TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham,
    TextSize = 14,
})
Create("UICorner", {Parent = autoFriendBtn, CornerRadius = UDim.new(0, 8)})

autoFriendBtn.MouseButton1Click:Connect(function()
    autoWhitelist = not autoWhitelist
    autoFriendBtn.BackgroundColor3 = autoWhitelist and COLORS.ButtonActive or COLORS.Button
    if autoWhitelist then
        for _, p in pairs(Players:GetPlayers()) do
            pcall(function()
                if LocalPlayer:IsFriendsWith(p.UserId) then
                    if not table.find(WHITELIST, p.Name) then
                        table.insert(WHITELIST, p.Name)
                    end
                end
            end)
        end
    end
end)

local clearWhitelistBtn = Create("TextButton", {
    Parent = Content,
    Size = UDim2.new(1, 0, 0, 30),
    Text = "ClearㅤWhitelist",
    BackgroundColor3 = COLORS.Button,
    TextColor3 = COLORS.Text,
    Font = Enum.Font.Gotham,
    TextSize = 14,
})
Create("UICorner", {Parent = clearWhitelistBtn, CornerRadius = UDim.new(0, 8)})

clearWhitelistBtn.MouseButton1Click:Connect(function()
    WHITELIST = {}
end)
-- Часть 8: Функция ультра атаки
local function UltraAttack(p)
    if IsWhitelisted(p) then return end
    
    pcall(function()
        local c = p.Character
        if not c then return end
        
        local h = c:FindFirstChildOfClass("Humanoid")
        local r = c:FindFirstChild("HumanoidRootPart")
        local l = LocalPlayer.Character
        if not h or h.Health <= 0 or not r or not l then return end
        
        local rh = l:FindFirstChild("RightHand")
        local lh = l:FindFirstChild("LeftHand")
        if not rh or not lh then return end
        
        for _ = 1, 3 do
            firetouchinterest(r, rh, 0)
            firetouchinterest(r, rh, 1)
            firetouchinterest(r, lh, 0)
            firetouchinterest(r, lh, 1)
            muscleEvent:FireServer("punch", rh.Name)
            muscleEvent:FireServer("punch", lh.Name)
            task.wait(0.01)
        end
    end)
end
-- Часть 9: Запуск атаки и режимы
local activeMode, attackCoroutine = nil, nil
local alivePlayers = {}

local function RefreshAlive()
    alivePlayers = {}
    for _, p in pairs(Players:GetPlayers()) do
        if p ~= LocalPlayer and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            local h = p.Character:FindFirstChildOfClass("Humanoid")
            if h and h.Health > 0 and not IsWhitelisted(p) then
                table.insert(alivePlayers, p)
            end
        end
    end
end

Players.PlayerAdded:Connect(RefreshAlive)
Players.PlayerRemoving:Connect(RefreshAlive)
RunService.Heartbeat:Connect(RefreshAlive)

local originalCFrames = {}

local function StartAttack(mode)
    if attackCoroutine then task.cancel(attackCoroutine) end
    activeMode = mode
    
    attackCoroutine = task.spawn(function()
        while activeMode == mode do
            local l = LocalPlayer.Character
            local lr = l and l:FindFirstChild("HumanoidRootPart")
            if not lr then task.wait() continue end
            
            local rad = tonumber(radiusBox.Text) or 75
            rad = math.clamp(rad, 75, 1000)

            if mode == "KillAura" then
                for _, p in ipairs(alivePlayers) do
                    local char = p.Character
                    if char then
                        local hrp = char:FindFirstChild("HumanoidRootPart")
                        if hrp and (hrp.Position - lr.Position).Magnitude <= rad then
                            UltraAttack(p)
                        end
                    end
                end
                task.wait(0.01)

            elseif mode == "AutoKill" then
                for _, p in ipairs(alivePlayers) do
                    task.spawn(UltraAttack, p)
                end
                task.wait(0.01)

            elseif mode == "AutoKillBasic" then
                for _, p in ipairs(alivePlayers) do
                    local char = p.Character
                    if char then
                        local hrp = char:FindFirstChild("HumanoidRootPart")
                        if hrp then
                            if not originalCFrames[p] then 
                                originalCFrames[p] = hrp.CFrame 
                            end
                            hrp.CFrame = lr.CFrame * CFrame.new(0, 0, -2)
                            UltraAttack(p)
                        end
                    end
                end
                task.wait(0.01)

            elseif mode == "KillTarget" then
                local targetName = nameBox.Text
                if targetName ~= "" then
                    for _, p in ipairs(alivePlayers) do
                        if p.Name:lower():find(targetName:lower()) or p.DisplayName:lower():find(targetName:lower()) then
                            UltraAttack(p)
                        end
                    end
                end
                task.wait(0.01)
            else
                task.wait()
            end
        end
        
        if mode == "AutoKillBasic" then
            for p, cf in pairs(originalCFrames) do
                if p and p.Character then
                    local hrp = p.Character:FindFirstChild("HumanoidRootPart")
                    if hrp then hrp.CFrame = cf end
                end
            end
            originalCFrames = {}
        end
    end)
end
-- Часть 10: Кнопки переключения режимов
local buttons = {}
local function ResetButtons()
    for _, b in pairs(buttons) do
        b.BackgroundColor3 = COLORS.Button
    end
end

local function CreateToggle(txt, m)
    local b = Create("TextButton", {
        Parent = Content, Size = UDim2.new(1, 0, 0, 30), Text = txt,
        BackgroundColor3 = COLORS.Button, TextColor3 = COLORS.Text,
        Font = Enum.Font.Gotham, TextSize = 14,
    })
    Create("UICorner", {Parent = b, CornerRadius = UDim.new(0, 8)})
    b.MouseButton1Click:Connect(function()
        if activeMode == m then
            activeMode = nil
            ResetButtons()
            if attackCoroutine then task.cancel(attackCoroutine) end
        else
            ResetButtons()
            b.BackgroundColor3 = COLORS.ButtonActive
            StartAttack(m)
        end
    end)
    table.insert(buttons, b)
end

CreateToggle("AutoㅤKill", "AutoKill")
CreateToggle("AutoㅤKillㅤBasic", "AutoKillBasic")
CreateToggle("UKillㅤAura", "KillAura")
CreateToggle("KillㅤTarget", "KillTarget")
-- Часть 11: Система блокировки позиции
local lockPosBtn = Create("TextButton", {
    Parent = Content, Size = UDim2.new(1, 0, 0, 30),
    Text = "LockㅤPos", BackgroundColor3 = COLORS.Button,
    TextColor3 = COLORS.Text, Font = Enum.Font.Gotham, TextSize = 14,
})
Create("UICorner", {Parent = lockPosBtn, CornerRadius = UDim.new(0, 8)})
local posLock = false
local posLockConn = nil
local lastPos

lockPosBtn.MouseButton1Click:Connect(function()
    if not posLock then
        local c = LocalPlayer.Character
        if c and c:FindFirstChild("HumanoidRootPart") then
            lastPos = c.HumanoidRootPart.CFrame
            posLockConn = RunService.Heartbeat:Connect(function()
                if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = lastPos
                end
            end)
            posLock = true
            lockPosBtn.BackgroundColor3 = COLORS.ButtonActive
        end
    else
        if posLockConn then posLockConn:Disconnect() end
        posLock = false
        lockPosBtn.BackgroundColor3 = COLORS.Button
    end
end)
-- Часть 12: Кнопка переключения UI
local ToggleGui = Create("ScreenGui", {Name = "MuscleKillerToggleGui", Parent = CoreGui, ResetOnSpawn = false})
local ToggleBtn = Create("TextButton", {
    Parent = ToggleGui, Size = UDim2.new(0, 35, 0, 35),
    Position = UDim2.new(0, 20, 0.5, -17), Text = "≡",
    Font = Enum.Font.GothamBold, TextSize = 18, TextColor3 = COLORS.Text,
    BackgroundColor3 = Color3.fromRGB(80, 80, 80), BackgroundTransparency = 0.2,
    Draggable = true, ZIndex = 10,
})
Create("UICorner", {Parent = ToggleBtn, CornerRadius = UDim.new(1, 0)})
ToggleBtn.MouseButton1Click:Connect(function()
    Frame.Visible = not Frame.Visible
end)
-- Часть 13: Автоматический респаун
local function SetupRespawn(player)
    local function onChar(char)
        char:WaitForChild("Humanoid").Died:Connect(function()
            task.defer(function() player:LoadCharacter() end)
        end)
    end
    if player.Character then onChar(player.Character) end
    player.CharacterAdded:Connect(onChar)
end
SetupRespawn(LocalPlayer)
